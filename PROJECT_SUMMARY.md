# Project Fanfiq: Итоговый документ и дорожная карта

## 1. О проекте

**Fanfiq** — это универсальная поисковая система и читалка для фанфиков, агрегирующая данные с множества популярных платформ. Проект спроектирован как современное monorepo-приложение, готовое к развертыванию и масштабированию.

### Ключевые компоненты:

*   **Бэкенд (`backend`)**:
    *   **API (FastAPI)**: Предоставляет эндпоинты для поиска, получения информации о работах и запуска парсинга.
    *   **Парсер (Celery Worker)**: Асинхронная система для сбора данных с сайтов. На данный момент реализован полный парсер для Ficbook.net.
    *   **База данных (PostgreSQL)**: Хранит все данные о работах, авторах и главах, используя полнотекстовый поиск (FTS) для быстрых и релевантных результатов.
    *   **Очереди (Redis)**: Используется как брокер для асинхронных задач парсинга.

*   **Фронтенд (`frontend`)**:
    *   Современное веб-приложение на **Next.js** и **TypeScript**.
    *   Пользовательский интерфейс, построенный на **Tailwind CSS** и **shadcn/ui**.
    *   Реализована страница поиска с отображением результатов.

*   **Деплой (Railway)**:
    *   Проект полностью сконфигурирован для автоматического развертывания на платформе Railway с использованием Docker.

---

## 2. Как развернуть проект (Deploy)

Это инструкция для администратора или владельца проекта для развертывания на Railway.

### Шаг 1: Полная очистка
*   Зайдите в ваш [проект на Railway](https://railway.app/).
*   Убедитесь, что там **нет ни одного сервиса**. Если есть какие-либо старые или падающие сервисы, **удалите их** (`Settings` -> `Delete Service`).

### Шаг 2: Создание сервисов
Вам нужно будет создать три сервиса из вашего GitHub репозитория.

1.  **Сервис `api`**:
    *   `+ New` -> `Deploy from GitHub repo`.
    *   В настройках `Root Directory` укажите: **`backend`**.
    *   `Dockerfile Path`: **`api/Dockerfile`**.
    *   **Переименуйте** сервис в `api`.
    *   В настройках `Deploy`, в поле `Start Command`, вставьте:
        `alembic -c api/alembic.ini upgrade head && uvicorn api.app.main:app --host 0.0.0.0 --port $PORT`

2.  **Сервис `worker`**:
    *   `+ New` -> `Deploy from GitHub repo`.
    *   `Root Directory`: **`backend`**.
    *   `Dockerfile Path`: **`workers/Dockerfile`**.
    *   **Переименуйте** сервис в `worker`.
    *   В `Deploy` -> `Start Command` вставьте:
        `celery -A workers.celery_app:app worker -Q crawl,normalize -l info`

3.  **Сервис `frontend`**:
    *   `+ New` -> `Deploy from GitHub repo`.
    *   `Root Directory`: **`frontend`**. (Dockerfile будет найден автоматически).
    *   **Переименуйте** сервис в `frontend`.

### Шаг 3: Добавление Баз Данных
*   `+ New` -> `Database` -> `PostgreSQL`.
*   `+ New` -> `Database` -> `Redis`.

### Шаг 4: Настройка Переменных Окружения
*   **Для сервиса `api`**:
    *   `DATABASE_URL` -> `${{Postgres.DATABASE_URL}}`
    *   `REDIS_URL` -> `${{Redis.REDIS_URL}}`
*   **Для сервиса `worker`**:
    *   `DATABASE_URL` -> `${{Postgres.DATABASE_URL}}`
    *   `REDIS_URL` -> `${{Redis.REDIS_URL}}`
    *   `CELERY_BROKER_URL` -> `${{Redis.REDIS_URL}}`
*   **Для сервиса `frontend`**:
    *   `NEXT_PUBLIC_API_URL` -> `https://${{api.RAILWAY_PUBLIC_DOMAIN}}`

После этих шагов деплой пройдет успешно, и все сервисы будут работать.

---

## 3. Как пользоваться проектом

### Веб-интерфейс (для пользователей)
Основной способ использования — через сайт, который будет доступен по публичному URL сервиса `frontend` на Railway.

### API (для разработчиков)
*   `POST /api/v1/works/search`: Поиск работ с фильтрами.
*   `GET /api/v1/works/{id}`: Получение полной информации о работе.
*   `POST /api/v1/crawl`: Запуск задачи парсинга для нового URL.

### CLI (для разработки и администрирования)
*   **Локальный парсинг**: `python backend/cli/crawl.py parse --url "..."`
*   **Постановка задачи в очередь**: `python backend/cli/crawl.py enqueue --url "..."`
*   **Экспорт данных**: `python backend/cli/export.py --id <work_id>`

---

## 4. Дорожная карта MVP

| Этап | Название | Статус | Ключевые результаты |
| :--- | :--- | :--- | :--- |
| **0** | Инфраструктура и Контракты | ✅ **Готово** | Docker, PostgreSQL, API-контракт |
| **1** | База данных и FTS | ✅ **Готово** | Модели SQLAlchemy, миграции, полнотекстовый поиск |
| **2** | Парсинг (Ficbook) | ✅ **Готово** | Полностью рабочий парсер Ficbook, Celery-очереди, CLI |
| **3** | Фронтенд MVP | ✅ **Готово** | Интерфейс поиска, отображение результатов |
| **4** | Деплой | ✅ **Готово** | Конфигурация для Railway, CI/CD |
| **5** | Будущие улучшения | ⏳ **В планах** | Страница-читалка, новые парсеры, аккаунты пользователей |

### Следующие шаги:
*   Реализовать страницу-читалку (`Reader`) на фронтенде.
*   Добавить парсеры для других сайтов (AO3, Wattpad и т.д.).
*   Расширить фильтры поиска.
*   Реализовать систему пользовательских аккаунтов и закладок.
*   Настроить мониторинг и логирование для production-среды.
